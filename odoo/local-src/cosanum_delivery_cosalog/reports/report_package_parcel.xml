<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright 2021 Camptocamp SA
     License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl). -->
<odoo>

  <template id="empty_layout" name="empty_layout">
    <t t-raw="0"/>
  </template>

  <!-- Template used for packages when printed from a picking.
    Goal: we want to print as many "package" report as there are CosaLog parcels
    configured on the product packaging of the package. So, if we have a package
    with a number of parcels of 3, we have to print 3 package reports for this package.

    Compared from the original report, we change several things:
      - remove the use of the 'web.basic_layout' to not get a '<div class="article">'
        for each parcel of a package to print (this kind of HTML block should
        be bind to the object we are printing, here pickings, as each block
        means 1 page in the qweb-pdf rendering.
      - iterate on 'parcels' instead of 'docs' (to not override the initial 'docs'
        used by the picking recordset)
      - display the parcels count under the name of the package (e.g. 1/3)
      - remove the package content (list of related quants)
    -->
  <template id="report_cosalog_package_label_parcel" inherit_id="stock.report_package_barcode" primary="True">
    <t t-call="web.basic_layout" position="attributes">
      <attribute name="t-call">cosanum_delivery_cosalog.empty_layout</attribute>
    </t>
    <div class="page" position="before">
      <!-- on first iteration 'current_package_id' doesn't exist, so the condition is always True -->
      <t t-if="current_package_id != o.id">
        <!-- Initialize/reset parcel number counter for new package -->
        <t t-set="parcel_number" t-value="0"/>
        <t t-set="current_package_id" t-value="o.id"/>
      </t>
      <t t-set="parcel_number" t-value="parcel_number + 1"/>
    </div>
    <t t-foreach="docs" position="attributes">
      <attribute name="t-foreach">parcels</attribute>
    </t>
    <!-- Display the parcels count -->
    <xpath expr="//h1[@t-field='o.name']/.." position="inside">
      <h2 class="mt-2">(Parcel <span t-esc="parcel_number"/>/<span t-esc="o.packaging_id.cosalog_number_of_parcels or 1"/>)</h2>
    </xpath>
    <!-- Remove package content (we target the <table> tag displaying
         the related quants here)
    -->
    <xpath expr="//t[@t-set='has_serial_number']/.." position="replace"/>
  </template>

  <!-- Template used by pickings to print its related CosaLog packages.
    This is at this level we should call the 'web.html_container' and
    'web.external_layout' (which was done before by the 'web.basic_layout' in the
    package report).
    For each package we are calling the specific package barcode/label report
    written for this purpose.
    -->
  <template id="report_cosalog_package_label" name="report_cosalog_package_label">
    <t t-call="web.html_container">
      <t t-foreach="docs" t-as="o">
        <t t-call="web.external_layout">
          <t t-set="company" t-value="user.company_id" />
            <t t-call="cosanum_delivery_cosalog.report_cosalog_package_label_parcel">
              <t t-set="parcels" t-value="o.report_cosalog_parcel_ids"/>
              <!-- List of parcel numbers from which we will pop the current parcel number -->
            </t>
        </t>
      </t>
    </t>
  </template>

</odoo>
